<!doctype html>
<html lang="en">
    <head>
        <style>
            html {
                height: 100%;
            }
            /* vv (Mostly) Bootstrap imports vv */
            /* License: https://github.com/twbs/bootstrap/blob/v4.0.0/LICENSE */
            body {
                padding: 0 10px 10px 10px;
                margin: 0;
                font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
                font-size: 1rem;
                font-weight: 400;
                color: #6a6b75;
                height: 100%;
            }
            *, ::after, ::before {
                box-sizing: border-box;
            }
            .form-group {
                margin-bottom: 1rem;
            }
            .form-group input,label,button  {
                display: block;
            }
            .form-group label {
                margin-left: .3rem;
                margin-bottom: .4rem;
                font-weight: 400;
            }
            .form-control {
                display: block;
                width: 100%;
                padding: .3rem .3rem;
                font-size: .8rem;
                line-height: 1.5;
                color: #6a6b75;
                background-color: #fff;
                background-clip: padding-box;
                border: 1px solid #dedede;
                border-radius: .25rem;
                transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            }
            .was-validated:invalid {
                border-color: #dc3545;
            }
            .was-validated:focus:invalid {
                box-shadow: 0 0 0 0.1rem rgba(199, 23, 73, 0.5);
                outline: 0;
            }
            .was-validated:valid {
                border-color: #22c22a;
            }
            .was-validated:focus:valid {
                box-shadow: 0 0 0 0.1rem rgba(52, 212, 52, 0.5);
                outline: 0;
            }

            .was-validated:focus {
                box-shadow: 0 0 0 0.1rem rgba(199, 23, 73, 0.5);
                outline: 0;
            }
            select.form-control:not([size]):not([multiple]) {
                height: calc(1.8rem + 2px);
            }
            .btn {
                display: block;
                width: 100%;

                background-color: #ec2059;
                border-color: #ec2059;
                color: #fff;
                border-radius: 30px;
                text-transform: uppercase;

                font-weight: 600;
                text-align: center;
                white-space: nowrap;
                vertical-align: middle;
                user-select: none;
                border: 1px solid transparent;
                padding: .375rem .75rem;
                font-size: 1rem;
                line-height: 1.5;

                transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            }
            .btn:not(:disabled):not(.disabled) {
                cursor: pointer;
            }
            .btn:focus, .btn.focus {
                box-shadow: 0 0 0 0.2rem rgba(199, 23, 73, 0.5);
                outline: 0;
            }
            .btn:hover {
                background-color: #af0b3a;
                border-color: #af0b3a;
            }
            .btn:not(:disabled):not(.disabled):active, .btn:not(:disabled):not(.disabled).active, .show > .btn.dropdown-toggle {
                background-color: #7c0628;
                border-color: #7c0628;
            }
            .btn:not(:disabled):not(.disabled):active:focus, .btn:not(:disabled):not(.disabled).active:focus, .show > .btn.dropdown-toggle:focus {
                box-shadow: 0 0 0 0.2rem rgba(199, 23, 73, 0.5);
            }
            .small, small {
                font-size: 80%;
                font-weight: 400;
            }
            a {
                color: #007bff;
                text-decoration: none;
                background-color: transparent;
            }
            /* ^^ Bootstrap imports ^^ */

            textarea {
                resize: none;
            }

            .powered-by {
                color: black;
                padding-top: 10px;
                display: block;
                width: 100%;
                text-align: right;
                font-size: .5rem;
            }

            *:focus {
                box-shadow: 0 0 0 0.1rem rgba(106, 107, 117, 0.5);
                outline: 0;
            }

            #feedback-form {
                height: 100%;
                /* Initial state before fade-in */
                opacity: 0;
                border-top: 1px solid #ececec;
                padding-top: 1rem;
            }

            #bottom-group {
                margin-bottom: 0px;
                margin-top: 2rem;
            }

            .fade-in {
                opacity: 1 !important;
                animation-name: fadeInOpacity;
                animation-iteration-count: 1;
                animation-timing-function: ease-in;
                animation-duration: .3s;
            }

            @keyframes fadeInOpacity {
                0% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }

            .fill {
                display: flex;
                height: 100%;
                flex-direction: column;
            }

            .inline-icon-container {
                vertical-align: middle;
                display: inline-block;
                margin: -3px 2px;
            }

            .inline-icon-container svg {
                height: 12px;
                width: auto;
                max-width: 12px;
            }

            #description {
                flex: 1;
            }
        </style>
    </head>
    <body>
        <form id="feedback-form" name="feedback-form" class="feedback-form fill">
            <div class="form-group">
                <label for="title">Title</label>
                <input
                    class="form-control"
                    type="text"
                    id="title"
                    name="title"
                    placeholder="Provide a short, descriptive title"
                    onfocus="resetSendButton()"
                    required
                    />
            </div>

            <div class="form-group">
                <label for="type">Type</label>
                <select
                        class="form-control"
                        id="type"
                        name="type"
                        onfocus="resetSendButton()"
                        required>
                    <option value="" disabled selected>Select one</option>
                    <option value="bug">Bug</option>
                    <option value="feature">Feature Request</option>
                    <option value="design">Design Issue</option>
                </select>
            </div>

            <!-- TODO: Have this fill in the height -->
            <div class="form-group fill">
                <label for="description">Description</label>
                <textarea
                    class="form-control"
                    id="description"
                    placeholder="Tell us how to improve&ndash;the more detail the better"
                    onfocus="resetSendButton()"
                    required
                    ></textarea>
            </div>
    
            <div class="form-group" id="bottom-group">
                <button class="btn" type="button" id="send-button" name="send-button" onclick="submitForm(event)">SEND</button>
                <!-- Powered matches that of Drift chat -->
                <small class="powered-by">Feedback<span class="inline-icon-container"><i><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 9.15 12.64"><g data-name="Layer 2"><g data-name="Layer 1"><path fill="#fcf4a0" d="M6.58.75L.75 7.06h3.54l-1.95 4.83L8.4 5.24H4.57L6.58.75z"></path><path d="M6.58.75l-2 4.49H8.4l-6.06 6.65 2-4.83H.75L6.58.75m0-.75a.67.67 0 0 0-.37.11.65.65 0 0 0-.21.13L.2 6.55a.75.75 0 0 0 .55 1.26h2.43l-1.54 3.8a.76.76 0 0 0 .3.92.8.8 0 0 0 .4.11.74.74 0 0 0 .55-.24L9 5.75a.75.75 0 0 0-.6-1.26H5.73L7.24 1.1a.68.68 0 0 0 .09-.35.75.75 0 0 0-.74-.75zm0 1.5z" fill="#f4a51f"></path></g></g></svg></i></span>by <a href="https://www.unbird.com" target="_blank">Unbird</a></small>
            </div>
        </form>

        <script src="https://pendo-io-extensions.storage.googleapis.com/sdk/0.1.0/js/pendo-extensions-sdk.js"></script>
        <script type = "text/javascript">

            var apiKey;
            var host = 'https://app.unbird.com';
            var hasSent = false;
            var extraProperties = {};

            window.onload = function() {
                // See https://github.com/pendo-io/resource-center-integration-kit
                const client = PendoSDK.GetConnection("unbird-feedback");
                client.initialize();

                client.get('metadata').then((result) => {
                    if (result != null && result.data != null) {
                        const visitorData = result.data.metadata.visitor;
                        if (visitorData != null) {
                            Object.keys(visitorData).forEach(function(key) {
                                extraProperties['pendo_visitor_' + key] = visitorData[key];
                            });
                        }

                        const accountData = result.data.metadata.account;
                        if (accountData != null) {
                            Object.keys(accountData).forEach(function(key) {
                                extraProperties['pendo_account_' + key] = accountData[key];
                            });
                        }
                    }
                });

                client.get('extension.config').then((result) => {
                    if (result == null || result.data == null) {
                        console.warn('Running outside of the Pendo iframe, unable to get config. Using local options');
                        // Replace me when running locally
                        apiKey = 'F2sjqH10JU2mPmhUnicnnFiT2ctu6j4r';
                        host = 'http://localhost:3000';
                        return;
                    }
                    apiKey = result.data.config.provider.options.apiKey;
                    if (result.data.config.options.stylesheet != null) {
                        var customStyleLink = document.createElement("link");
                        customStyleLink.rel = "stylesheet";
                        customStyleLink.type = "text/css";
                        customStyleLink.href = result.data.config.options.stylesheet;
                        document.getElementsByTagName("head")[0].appendChild(customStyleLink)
                    }
                });
            }

            document.getElementById('feedback-form').classList.add("fade-in");

            function resetForm() {
                var form = document.forms['feedback-form'];

                resetFormControlValue(form.elements['title']);
                resetFormControlValue(form.elements['type']);
                resetFormControlValue(form.elements['description']);
            }

            function validateForm() {
                var valid = true;
                var formControlIds = ['title', 'type', 'description'];
                formControlIds.forEach(function (controlId) {
                    if (!validateFormControlValue(document.getElementById(controlId))) {
                        valid = false;
                    }
                });
                return valid;
            }

            function resetSendButton() {
                var sendButton = document.getElementById('send-button');
                sendButton.innerText = "Send" + (hasSent === true ? " another" : "");
            }

            function validateFormControlValue(element) {
                element.classList.add("was-validated");
                return element.value.length > 0;
            }

            function resetFormControlValue(element) {
                element.classList.remove("was-validated");
                element.value = '';
            }

            function submitForm(event) {
                if (apiKey == null) {
                    console.error('No API Key has been loaded');
                    return;
                }

                if (!validateForm()) {
                    console.warn('Form not ready to submit')
                    return;
                }

                var form = document.forms['feedback-form'];
                var sendButton = form.elements['send-button'];

                var title = form.elements['title'].value;
                var type = form.elements['type'].value;
                var description = form.elements['description'].value;
                var fieldProperties = {
                    type: type,
                    title: title,
                };
                Object.keys(extraProperties).forEach(function(key) {
                    fieldProperties[key] = extraProperties[key];
                });

                sendButton.innerText = "SENDING..."
                sendButton.disable = true;
                fetch(`${host}/widget/v2/entry/${apiKey}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        entry: description,
                        properties: fieldProperties,
                    })
                }).then(response => {
                    if (response.status !== 200) {
                        throw Error(`Got non-success response ${response.status} ${response.statusText}`);
                    }
                    resetForm();
                    sendButton.innerText = "Successfully sent!";
                    sendButton.disable = false;
                    hasSent = true;
                }).catch(error => {
                    console.log('Problem adding entry', error);
                    sendButton.innerText = "Try again";
                    sendButton.disable = false;
                })
            }

        </script>
    </body>
</html>
